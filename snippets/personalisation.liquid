
{% if product.metafields.custom.personalisation.value == true %}
<div class="techplusd2c-container" id="techplusd2c-bentoContainer">
    <div class="techplusd2c-header">
      <span class="techplusd2c-label-text bold">Personalise for just ₹{{ product.metafields.custom.personalisation_amount.value |  default: 149 }}</span>
      <label class="techplusd2c-toggle">
        <input type="checkbox" id="techplusd2c-personalizeCheckbox" class="techplusd2c-checkbox">
        <span class="techplusd2c-slider"></span>
      </label>
    </div>
    <div class="techplusd2c-bento-form" id="techplusd2c-bentoForm">
    <!-- <input type="text" maxlength="8" placeholder="8 characters left"> -->
    <form id="techplusd2c-form">
        <div class="techplusd2c-input-wrapper">
        <input type="text" id="techplusd2c-input" maxlength="8" placeholder="8 characters left" autocomplete="off" required>
        <button type="submit" class="techplusd2c-submit-btn" id="techplusd2c-submitButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M13.1665 7.82544H3.1665" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9.1333 3.9917L11.15 5.90843L13.1154 7.87385M13.1666 7.82515L9.1333 11.6592" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        </div>
    </form>
    <div class="techplusd2c-form-note" id="techplusd2c-msg"></div>
    <div class="techplusd2c-note" onclick="showClickPopupCreate()">* <span>Click here</span> see how your personalisation looks</div>
    <div class="techplusd2c-note">* Personalised products are not returnable unless there is a manufacturing defect.</div>
    </div>

    <!-- popup start -->
    <div id="techplusd2c-popupOverlayCreate" class="popup-overlay-create" onclick="closePopupCreate()">
    <div class="popup-box-create" onclick="event.stopPropagation();">
        <div class="close-btn-create" onclick="closePopupCreate()">×</div>
        {% if product.metafields.custom.personalisation_pop_up_image != blank %}
        <img class="popup-box-img-create" src="/cdn/shop/{{ product.metafields.custom.personalisation_pop_up_image.value }}" alt="Personalization Image" />
        {% endif %}
    </div>
    </div>
    <!-- popup end  -->
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const checkbox = document.getElementById('techplusd2c-personalizeCheckbox');
    const form = document.getElementById('techplusd2c-bentoForm');
    const container = document.getElementById('techplusd2c-bentoContainer');
    const realForm = document.getElementById('techplusd2c-form');
    const input = document.getElementById('techplusd2c-input');
    // Add input restriction to alphabets only
    input.addEventListener('input', function () {
        this.value = this.value.replace(/[^a-zA-Z]/g, '');
    });
    
    const submitButton = document.getElementById('techplusd2c-submitButton');
    const msgElement = document.getElementById('techplusd2c-msg');
    const originalSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13.1665 7.82544H3.1665" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.1333 3.9917L11.15 5.90843L13.1154 7.87385M13.1666 7.82515L9.1333 11.6592" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    const firstVariantId = window.meta?.product?.variants?.[0]?.id || window.product?.variants?.[0]?.id;
    const secondVariantId = window.meta?.product?.variants?.[1]?.id || window.product?.variants?.[1]?.id;
    const shopifyForm = document.querySelector('.shopify-section--main-product .product-info .product-info__block-item[data-block-type="quantity-selector"] form');
    const variantInput = document.querySelector('.shopify-section--main-product .product-info .product-info__block-item[data-block-type="quantity-selector"] form input[name="id"]');

    // Utility: remove existing personalization input
    function removePersonalizationInput() {
        const existing = shopifyForm.querySelector('input[name="properties[Personalise]"]');
        if (existing) {
        existing.remove();
        }
    }
    
    checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
        form.style.display = 'flex';
        container.classList.add('techplusd2c-checked');
        } else {
        form.style.display = 'none';
        container.classList.remove('techplusd2c-checked');

        // RESET everything when unchecked
        input.value = "";
        submitButton.innerHTML = originalSVG;
        msgElement.textContent = "";
        variantInput.value = firstVariantId;
        
        // let existing = shopifyForm.querySelector('input[name="properties[Personalise]"]');
        // if (existing) {
        //   existing.remove();
        // }
        removePersonalizationInput();
        }
    });

    realForm.addEventListener('submit', (e) => {
        e.preventDefault();

        removePersonalizationInput();
        
        if (input.value.trim().length >= 1) {
        submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 12 8" fill="none"><path d="M2 4.16667L4.66667 6.5L10 1.5" stroke="#FFC844" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        msgElement.textContent = "Yay! That fits perfectly. Looks short & sweet!";
        variantInput.value = secondVariantId;

        const personalizationInput = document.createElement('input');
        personalizationInput.type = 'hidden';
        personalizationInput.name = 'properties[Personalise]';
        personalizationInput.value = input.value;
        shopifyForm.appendChild(personalizationInput);
        } else {
        alert('Please enter at least 1 character.');
        }
    });

    input.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') {
        submitButton.innerHTML = originalSVG;
        msgElement.textContent = "";
        variantInput.value = firstVariantId;

        // let existing = shopifyForm.querySelector('input[name="properties[Personalise]"]');
        // if (existing) {
        //   existing.remove();
        // }
        removePersonalizationInput();
        }
    });

    input.addEventListener('blur', () => { // mainly written this code to submit the form through 'done' btn from ios keyboard
        if (input.value.trim().length >= 1) {

        removePersonalizationInput();
        
        submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 12 8" fill="none"><path d="M2 4.16667L4.66667 6.5L10 1.5" stroke="#FFC844" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        msgElement.textContent = "Yay! That fits perfectly. Looks short & sweet!";
        variantInput.value = secondVariantId;

        const personalizationInput = document.createElement('input');
        personalizationInput.type = 'hidden';
        personalizationInput.name = 'properties[Personalise]';
        personalizationInput.value = input.value;
        shopifyForm.appendChild(personalizationInput);
        } else {
        alert('Please enter at least 1 character.');
        }
    });
    });

    function showClickPopupCreate() {
    document.getElementById('techplusd2c-popupOverlayCreate').style.display = 'flex';
    document.body.style.overflow = 'hidden'; 
    }
    
    function closePopupCreate() {
    document.getElementById('techplusd2c-popupOverlayCreate').style.display = 'none';
    document.body.style.overflow = '';
    }
</script>
{%- endif -%}

       