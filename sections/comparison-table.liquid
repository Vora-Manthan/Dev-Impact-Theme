{%- render 'section-spacing-collapsing' -%}

{%- assign text_position = section.settings.text_position -%}
{%- assign values_blocks = section.blocks | where: 'type', 'values' -%}
{%- assign values_column_count = values_blocks.size -%}

<style>
  #shopify-section-{{ section.id }} {
    --comparison-grid-cols: minmax(150px, 200px) repeat({{ values_column_count }}, minmax(200px, 1fr));
    --comparison-card-radius: 20px;
    --comparison-bg-color: {{ section.settings.background | default: '#fffdf7' }};
  }

  .comparison-table-container {
    background-color: var(--comparison-bg-color);
    padding: 3rem 1rem;
    width: 100%;
    margin: 0 auto;
  }

  .comparison-grid {
    display: grid;
    grid-template-columns: var(--comparison-grid-cols);
    grid-auto-rows: auto;
    gap: 0;
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
    overflow-x: auto;
    padding-bottom: 2rem; /* Space for shadow */
  }

  /* Global Cell Styling */
  .comparison-cell {
    padding: 1rem 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
    z-index: 2;
  }
  
  .comparison-cell--label {
    justify-content: flex-start;
    text-align: left;
    font-weight: 600;
    color: {{ section.settings.text_color }};
    padding-left: 0;
  }

  /* Value Borders */
  .comparison-cell--value {
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  /* Card Background (Pseudo-columns) */
  .comparison-card-bg {
    grid-row: 1 / -1;
    border-radius: var(--comparison-card-radius);
    background: {{ section.settings.chart_background | default: '#ffffff' }};
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    pointer-events: none;
    z-index: 1;
    margin: 0 10px;
  }

  /* Product Header (Image + Title) */
  .comparison-header {
    flex-direction: column;
    gap: 1rem;
    padding-top: 2rem;
    padding-bottom: 1rem;
  }
  
  .product-image-wrapper {
    width: 100%;
    aspect-ratio: 1 / 0.85;
    border-radius: calc(var(--comparison-card-radius) - 1px) calc(var(--comparison-card-radius) - 1px) 0 0;
    overflow: hidden;
    margin: -2rem -1rem 0 -1rem; /* Negative margin to fill top of card */
    max-width: calc(100% + 2rem);
    background: {{ section.settings.background_gradient | default: '#f5f5f5' }};
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .product-image-wrapper:hover img {
    transform: scale(1.05);
  }

  .product-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-top: 0.5rem;
  }

  /* Footer (Price + Button) */
  .comparison-footer {
    flex-direction: column;
    gap: 1rem;
    padding-bottom: 2rem;
    border-bottom: none;
    margin-top: auto; /* Push to bottom if height allows */
  }

  .price-display {
    display: flex;
    gap: 0.5rem;
    align-items: baseline;
    font-size: 0.9rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .price-sale {
    color: #e65100;
    font-weight: 700;
    font-size: 1.2rem;
  }

  .price-compare {
    color: #999;
    text-decoration: line-through;
    font-size: 0.85rem;
  }

  .buy-button {
    background: #d4e157; /* Lime Green Default */
    color: #000;
    border-radius: 9999px;
    padding: 0.75rem 1.5rem;
    font-weight: 700;
    text-decoration: none;
    width: 90%;
    text-align: center;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .buy-button:hover {
    filter: brightness(0.95);
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .section-intro {
    text-align: center;
    margin-bottom: 3rem;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Icon styling */
  .icon-check { stroke: #66bb6a; }
  .icon-cross { stroke: #ef5350; }

  @media screen and (max-width: 768px) {
    .comparison-grid {
      /* Enable horizontal scroll on mobile */
      grid-template-columns: 120px repeat({{ values_column_count }}, 220px);
      padding-right: 1rem;
    }
    .comparison-card-bg {
      margin: 0 5px;
    }
    .product-image-wrapper {
       aspect-ratio: 1 / 1;
    }
  }
</style>

<div {% render 'section-properties' %}>
  {%- if section.settings.subheading != blank or section.settings.title != blank -%}
    <div class="section-intro">
      {%- if section.settings.title != blank -%}
        <h2 class="h2">
          {%- render 'styled-text', content: section.settings.title, text_color: section.settings.heading_color, gradient: section.settings.heading_gradient -%}
        </h2>
      {%- endif -%}
      {%- if section.settings.subheading != blank -%}
        <p class="subheading">{{ section.settings.subheading | escape }}</p>
      {%- endif -%}
    </div>
  {%- endif -%}

  <div class="comparison-table-container">
    <div class="comparison-grid">
      
      {%- comment -%} Background Cards (Grid Overlay) {%- endcomment -%}
      {%- for block in values_blocks -%}
        <div class="comparison-card-bg" style="grid-column: {{ forloop.index | plus: 1 }}; grid-row: 1 / -1;"></div>
      {%- endfor -%}

      {%- comment -%} 
        ROW 1: HEADERS 
      {%- endcomment -%}
      
      <div class="comparison-cell comparison-cell--label" style="grid-column: 1; grid-row: 1;">
        <!-- Placeholder for top-left label if needed -->
      </div>

      {%- for block in values_blocks -%}
        {%- assign product = block.settings.product -%}
        <div class="comparison-cell comparison-header" style="grid-column: {{ forloop.index | plus: 1 }}; grid-row: 1;">
          {%- if section.settings.show_product_image -%}
            <div class="product-image-wrapper">
              {%- if product.featured_media -%}
                {{- product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', sizes: '300px', widths: '300,400,600' -}}
              {%- else -%}
                 {{ 'product-1' | placeholder_svg_tag }}
              {%- endif -%}
            </div>
          {%- endif -%}
          <div class="product-title">{{- product.title | default: 'Product Title' -}}</div>
        </div>
      {%- endfor -%}


      {%- comment -%} 
        ROWS 2..21: FEATURES 
      {%- endcomment -%}
      {%- assign headings_block = section.blocks | where: 'type', 'headings' | first -%}
      
      {%- assign row_index_offset = 2 -%}
      <!-- Start with visual_row counter at 2 (1 is header) -->
      {%- assign current_grid_row = 2 -%}
      
      {%- for i in (1..20) -%}
        {%- assign heading_key = 'heading_' | append: i -%}
        {%- assign value_key = 'value_' | append: i -%}
        
        {%- assign heading_value = headings_block.settings[heading_key] -%}
        
        {%- comment -%} Check if row has any content to display {%- endcomment -%}
        {%- assign has_content = false -%}
        {%- if heading_value != blank -%}{%- assign has_content = true -%}{%- endif -%}
        {%- unless has_content -%}
          {%- for block in values_blocks -%}
            {%- if block.settings[value_key] != blank -%}{%- assign has_content = true -%}{%- break -%}{%- endif -%}
          {%- endfor -%}
        {%- endunless -%}

        {%- if has_content -%}
          {%- comment -%} LABEL COLUMN {%- endcomment -%}
          <div class="comparison-cell comparison-cell--label" style="grid-column: 1; grid-row: {{ current_grid_row }};">
            {{- heading_value -}}
          </div>

          {%- comment -%} VALUE COLUMNS {%- endcomment -%}
          {%- for block in values_blocks -%}
             <div class="comparison-cell comparison-cell--value" style="grid-column: {{ forloop.index | plus: 1 }}; grid-row: {{ current_grid_row }};">
                {%- assign value = block.settings[value_key] -%}
                {%- assign stripped_value = value | strip_html | strip -%}
                
                {%- if stripped_value == 'FALSE' or stripped_value == 'False' -%}
                  <svg fill="none" class="icon icon-cross" width="24" height="24" viewBox="0 0 24 24">
                     <circle cx="12" cy="12" r="10" stroke-width="2" fill="none"/>
                     <path d="M15 9L9 15M9 9L15 15" stroke-width="2" stroke-linecap="round"/>
                   </svg>
                {%- elsif stripped_value == 'TRUE' or stripped_value == 'True' -%}
                   <svg fill="none" class="icon icon-check" width="24" height="24" viewBox="0 0 24 24">
                     <circle cx="12" cy="12" r="10" stroke-width="2" fill="none"/>
                     <path d="M8 12L11 15L16 9" stroke-width="2" stroke-linecap="round"/>
                   </svg>
                {%- else -%}
                  <div class="prose text-subdued">{{- value | default: 'â€”' -}}</div>
                {%- endif -%}
             </div>
          {%- endfor -%}
          
          {%- assign current_grid_row = current_grid_row | plus: 1 -%}
        {%- endif -%}
      {%- endfor -%}

      {%- comment -%} 
        FOOTER ROW 
      {%- endcomment -%}
      {%- for block in values_blocks -%}
        {%- assign product = block.settings.product -%}
        <div class="comparison-cell comparison-footer" style="grid-column: {{ forloop.index | plus: 1 }}; grid-row: {{ current_grid_row }};">
           <div class="price-display">
             {%- if product.compare_at_price > product.price -%}
               <span class="price-sale">{{ product.price | money }}</span>
               <span class="price-compare">{{ product.compare_at_price | money }}</span>
             {%- else -%}
               <span class="price-sale">{{ product.price | money }}</span>
             {%- endif -%}
           </div>
           
           {%- assign button_text = section.settings.view_product | default: 'Buy Now' -%}
           <!-- Check for block specific button text if schema supported it, but we use defaults -->
           
           <a href="{{ product.url }}" class="buy-button">
             {{- button_text -}}
           </a>
        </div>
      {%- endfor -%}

    </div>
  </div>
</div>

{% schema %}
{
  "name": "Comparison table",
  "class": "shopify-section--comparison-table",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "A QUICK GUIDE TO HELP YOU CHOOSE THE RIGHT ONE"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Which Bento to Pick?"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "Content",
      "default": "<p>Give your customers useful information about your products and showcase differences between them.</p>"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text"
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "Button URL"
    },
    {
      "type": "select",
      "id": "text_position",
      "label": "Text position",
      "options": [
        {
          "value": "start",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Chart"
    },
    {
      "type": "text",
      "id": "view_product",
      "label": "View product button text",
      "default": "Buy Now"
    },
    {
      "type": "checkbox",
      "id": "show_product_info",
      "label": "Show product info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_product_image",
      "label": "Show product image",
      "default": true
    },
    {
      "type": "header",
      "content": "Colors",
      "info": "Gradient replaces solid colors when set."
    },
    {
      "type": "color",
      "id": "background",
      "label": "Section Background",
      "default": "#fffdf7"
    },
    {
      "type": "color_background",
      "id": "background_gradient",
      "label": "Background gradient"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color"
    },
    {
      "type": "color_background",
      "id": "heading_gradient",
      "label": "Heading gradient"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button background",
      "default": "#d4e157"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "chart_background",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "chart_text_color",
      "label": "Chart text"
    },
    {
      "type": "color",
      "id": "chart_true_false_color",
      "label": "True/false color"
    }
  ],
  "blocks": [
    {
      "name": "Headings column",
      "type": "headings",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "A heading without values is hidden automatically."
        },
        {
          "type": "text",
          "id": "heading_1",
          "label": "Heading 1"
        },
        {
          "type": "text",
          "id": "heading_2",
          "label": "Heading 2"
        },
        {
          "type": "text",
          "id": "heading_3",
          "label": "Heading 3"
        },
        {
          "type": "text",
          "id": "heading_4",
          "label": "Heading 4"
        },
        {
          "type": "text",
          "id": "heading_5",
          "label": "Heading 5"
        },
        {
          "type": "text",
          "id": "heading_6",
          "label": "Heading 6"
        },
        {
          "type": "text",
          "id": "heading_7",
          "label": "Heading 7"
        },
        {
          "type": "text",
          "id": "heading_8",
          "label": "Heading 8"
        },
        {
          "type": "text",
          "id": "heading_9",
          "label": "Heading 9"
        },
        {
          "type": "text",
          "id": "heading_10",
          "label": "Heading 10"
        },
        {
          "type": "text",
          "id": "heading_11",
          "label": "Heading 11"
        },
        {
          "type": "text",
          "id": "heading_12",
          "label": "Heading 12"
        },
        {
          "type": "text",
          "id": "heading_13",
          "label": "Heading 13"
        },
        {
          "type": "text",
          "id": "heading_14",
          "label": "Heading 14"
        },
        {
          "type": "text",
          "id": "heading_15",
          "label": "Heading 15"
        },
        {
          "type": "text",
          "id": "heading_16",
          "label": "Heading 16"
        },
        {
          "type": "text",
          "id": "heading_17",
          "label": "Heading 17"
        },
        {
          "type": "text",
          "id": "heading_18",
          "label": "Heading 18"
        },
        {
          "type": "text",
          "id": "heading_19",
          "label": "Heading 19"
        },
        {
          "type": "text",
          "id": "heading_20",
          "label": "Heading 20"
        }
      ]
    },
    {
      "name": "Values column",
      "type": "values",
      "limit": 3,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Select a product to connect metafields or to show product information."
        },
        {
          "type": "richtext",
          "id": "value_1",
          "label": "Value 1"
        },
        {
          "type": "richtext",
          "id": "value_2",
          "label": "Value 2"
        },
        {
          "type": "richtext",
          "id": "value_3",
          "label": "Value 3"
        },
        {
          "type": "richtext",
          "id": "value_4",
          "label": "Value 4"
        },
        {
          "type": "richtext",
          "id": "value_5",
          "label": "Value 5"
        },
        {
          "type": "richtext",
          "id": "value_6",
          "label": "Value 6"
        },
        {
          "type": "richtext",
          "id": "value_7",
          "label": "Value 7"
        },
        {
          "type": "richtext",
          "id": "value_8",
          "label": "Value 8"
        },
        {
          "type": "richtext",
          "id": "value_9",
          "label": "Value 9"
        },
        {
          "type": "richtext",
          "id": "value_10",
          "label": "Value 10"
        },
        {
          "type": "richtext",
          "id": "value_11",
          "label": "Value 11"
        },
        {
          "type": "richtext",
          "id": "value_12",
          "label": "Value 12"
        },
        {
          "type": "richtext",
          "id": "value_13",
          "label": "Value 13"
        },
        {
          "type": "richtext",
          "id": "value_14",
          "label": "Value 14"
        },
        {
          "type": "richtext",
          "id": "value_15",
          "label": "Value 15"
        },
        {
          "type": "richtext",
          "id": "value_16",
          "label": "Value 16"
        },
        {
          "type": "richtext",
          "id": "value_17",
          "label": "Value 17"
        },
        {
          "type": "richtext",
          "id": "value_18",
          "label": "Value 18"
        },
        {
          "type": "richtext",
          "id": "value_19",
          "label": "Value 19"
        },
        {
          "type": "richtext",
          "id": "value_20",
          "label": "Value 20"
        },
        {
          "type": "header",
          "content": "Colors"
        },
        {
          "type": "color",
          "id": "view_button_background",
          "label": "View product button background"
        },
        {
          "type": "color",
          "id": "view_button_text_color",
          "label": "View product button text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Comparison table",
      "category": "Products",
      "blocks": [
        {
          "type": "headings",
          "settings": {
            "heading_1": "Feature 1",
            "heading_2": "Feature 2"
          }
        },
        {
          "type": "values",
          "settings": {
            "value_1": "<p>Value 1</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
